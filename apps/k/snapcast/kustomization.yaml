apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
bases:
- ../../base/snapcast
components:
- ../../base/librespot
- ../../base/shairport-sync
- ../../base/snapcast-line-in
patchesStrategicMerge:
- |-
  apiVersion: apps/v1
  kind: StatefulSet
  metadata:
    name: snapserver
  spec:
    template:
      spec:
        nodeName: tiantao
        containers:
        - name: snapserver
          args:
          - --stream.source=meta:///AirPlay/Spotify/Turntable?name=Auto
          - --stream.source=pipe:///var/lib/fifo/shairport-sync?name=AirPlay&mode=read&sampleformat=44100:16:2
          - --stream.source=pipe:///var/lib/fifo/librespot?name=Spotify&mode=read&sampleformat=44100:16:2
          - --stream.source=tcp://$(LINE_IN_SERVICE_HOST):$(LINE_IN_SERVICE_PORT_AUDIO)?name=Turntable&mode=client
- |-
  apiVersion: v1
  kind: Service
  metadata:
    annotations:
      external-dns.alpha.kubernetes.io/hostname: snapcast.k.squat.ai
    name: snapserver
- |-
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: snapclient
  spec:
    template:
      spec:
        containers:
        - name: snapclient
          resources:
            limits:
              squat.ai/audio: 1
        nodeName: tiantao
- |-
  apiVersion: apps/v1
  kind: StatefulSet
  metadata:
    name: line-in
  spec:
    template:
      spec:
        containers:
        - name: line-in
          resources:
            limits:
              squat.ai/capture: 1
        nodeName: lu
