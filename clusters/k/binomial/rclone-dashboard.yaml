kind: Service
apiVersion: v1
metadata:
  annotations:
    external-dns.alpha.kubernetes.io/hostname: rclone.binomial.k.squat.ai
  labels:
    app.kubernetes.io/name: rclone-dashboard
  name: rclone-dashboard
  namespace: binomial
spec:
  ports:
    - port: 80
      targetPort: 8080
  selector:
    app.kubernetes.io/name: rclone-dashboard
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rclone-dashboard
  namespace: binomial
  labels:
    app.kubernetes.io/name: rclone-dashboard
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: rclone-dashboard
  template:
    metadata:
      labels:
        app.kubernetes.io/name: rclone-dashboard
    spec:
      initContainers:
      - name: config
        image: alpine
        command:
          - cp
        args:
          - -v
          - /in/rclone.conf
          - /out/rclone.conf
        volumeMounts:
        - name: config-in
          mountPath: /in
        - name: config-out
          mountPath: /out
      containers:
      - name: rclone
        image: rclone/rclone
        args:
          - rcd 
          - --rc-web-gui
          - --rc-addr=127.0.0.1:9090
          - --rc-web-gui-no-open-browser
          - --rc-user=admin
          - --rc-pass=password
          - --config=/etc/rclone/rclone.conf
        volumeMounts:
        - name: config-out
          mountPath: /etc/rclone
      - name: proxy
        image: quay.io/oauth2-proxy/oauth2-proxy:v7.1.2
        args:
        - --redirect-url=$(REDIRECT_URL)
        - --provider=oidc
        - --oidc-issuer-url=$(ISSUER_URL)
        - --client-id=$(CLIENT_ID)
        - --client-secret=$(CLIENT_SECRET)
        - --skip-provider-button=true
        - --cookie-secret=$(COOKIE_SECRET)
        - --cookie-secure=false
        - --cookie-refresh=1h
        - --email-domain=*
        - --alpha-config=/etc/oauth2-proxy/config.yaml
        env:
        - name: REDIRECT_URL
          valueFrom:
            secretKeyRef:
              name: rclone-dashboard
              key: REDIRECT_URL
        - name: ISSUER_URL
          valueFrom:
            secretKeyRef:
              name: rclone-dashboard
              key: ISSUER_URL
        - name: CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: rclone-dashboard
              key: CLIENT_ID
        - name: CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: rclone-dashboard
              key: CLIENT_SECRET
        - name: COOKIE_SECRET
          valueFrom:
            secretKeyRef:
              name: rclone-dashboard
              key: COOKIE_SECRET
        volumeMounts:
        - name: oauth2-proxy-config
          mountPath: /etc/oauth2-proxy
        ports:
        - containerPort: 8080
          protocol: TCP
      volumes:
      - name: config-out
        emptyDir: {}
      - name: config-in
        secret:
          secretName: rclone
      - name: oauth2-proxy-config
        secret:
          secretName: rclone-dashboard
          items:
          - key: oauth2-proxy-config.yaml
            path: config.yaml
